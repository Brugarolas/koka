#include <stdio.h>
#include "time.h"
#include "runtime.h"

static msecs_t test_timing(const char* msg, size_t loops, void (*fun)(integer,integer), integer x, integer y) {
  msecs_t start = _clock_start();
  for (size_t i = 0; i < loops; i++) {
    fun(integer_dup(x),integer_dup(y));    
  }
  msecs_t end = _clock_end(start);
  integer_decref(x);
  integer_decref(y);
  //printf("test %s, %zu iterations: %6.3f s\n", msg, loops, (double)(end)/1000.0);
  return end;
}


typedef integer(iop)(integer x, integer y);
typedef intptr_t(xop)(intptr_t x, intptr_t y);


static intptr_t check(intptr_t z) { if (z < SMALLINT_MIN || z > SMALLINT_MAX) return 10; return z; }
static intptr_t add(intptr_t x, intptr_t y) { return check(x + y); }
static intptr_t sub(intptr_t x, intptr_t y) { return check(x - y); }
static intptr_t mul(intptr_t x, intptr_t y) { return check(x * y); }

void testx(const char* name, iop* op, xop* opx, intptr_t i, intptr_t j) {
  integer x = box_int(i);
  integer y = box_int(j);
  intptr_t k = unbox_int(op(x, y));
  intptr_t expect = opx(i, j);
  printf("%16zx %s %16zx = %16zx: %4s   (expected %zx) %s\n", i, name, j, k, (k==expect ? "ok" : "FAIL"), expect, (k == 10 ? "(overflow)" : ""));
}
void testb(const char* name, iop* op, box_t x, box_t y, box_t expect ) {
  integer k = (op(x, y));
  printf("%16zx %s %16zx = %16zx: %4s   (expected %zx) %s\n", x, name, y, k, (k==expect ? "ok" : "FAIL"), expect, (k == 43 ? "(overflow)" : ""));
}
void test_op(const char* name, iop* op, xop* opx) {
  testx(name, op, opx, SMALLINT_MAX, 1);
  testx(name, op, opx, 0, 0);
  testx(name, op, opx, 1, 0);
  testx(name, op, opx, -1, 0);
  testx(name, op, opx, 0, 1);
  testx(name, op, opx, 0, 0);
  testx(name, op, opx, 0, -1);
  testx(name, op, opx, SMALLINT_MAX, 0);
  testx(name, op, opx, SMALLINT_MAX, -1);
  testx(name, op, opx, SMALLINT_MIN, 1);
  testx(name, op, opx, SMALLINT_MIN, 0);
  testx(name, op, opx, SMALLINT_MIN, -1);
  testx(name, op, opx, SMALLINT_MAX, SMALLINT_MAX);
  testx(name, op, opx, SMALLINT_MAX, SMALLINT_MIN);
  testx(name, op, opx, SMALLINT_MIN, SMALLINT_MAX);
  testx(name, op, opx, SMALLINT_MIN, SMALLINT_MIN);
  testb(name, op, 24, 24, 41);  // ptr + ptr
  testb(name, op, 24, 13, 41);  // ptr + int
  testb(name, op, 13, 24, 41);  // int + ptr
}

void test() {
  test_op("+", &integer_add, &add);
  test_op("-", &integer_sub, &sub);
  test_op("*", &integer_mul, &mul);
}

void test_add(integer x, integer y, integer expect) {
  integer_incref(x); integer_incref(y);
  integer_print(x); printf(" + "); integer_print(y); printf(" = ");
  integer z = integer_add(x, y);  
  integer_print(z); printf(", expected: "); 
  integer_print(expect);
  printf("\n");
}

void test_sub(integer x, integer y, integer expect) {
  integer_incref(x); integer_incref(y);
  integer_print(x); printf(" - "); integer_print(y); printf(" = ");
  integer z = integer_sub(x, y);
  integer_print(z); printf(", expected: ");
  integer_print(expect);
  printf("\n");
}

void fibx(int n, integer* x1, integer* x2) {
  if (n <= 1) {
    *x1 = box_int(0);
    *x2 = box_int(0);
  }
  else if (n == 2) {
    *x1 = box_int(1);
    *x2 = box_int(0);
  }
  else {
    integer y1; 
    integer y2;
    fibx(n - 1, &y1, &y2);
    *x2 = y1; integer_incref(y1);
    *x1 = integer_add(y1, y2);
  }
}

integer fib(int n) {
  integer y1;
  integer y2;
  fibx(n+1, &y1, &y2);
  integer_decref(y2);
  return y1;
}



void test_fib(int i) {
  printf("fib %i = ", i);
  integer_print(fib(i));
  printf("\n");
}

void test_read(const char* s) {
  printf("read %s = ", s);
  integer_print(integer_parse(s));
  printf("\n");
}

void expect(bool b, bool exp) {
  assert(b==exp);
}

void expect_eq(integer x, integer y) {
  integer_incref(x); integer_incref(y);
  printf(" "); integer_print(x); printf(" == ");  integer_print(y);
  bool eq = integer_eq(x, y);
  printf(" %s\n", (eq ? "ok" : "FAIL"));
  assert(eq);
}

void test_cmp_pos() {
  printf("cmp works for positive numbers?\n");
  
  expect(integer_gt(integer_from_small(54), integer_from_small(45)), true);
  expect(integer_gt(integer_from_small(45), integer_from_small(54)), false);
  expect(integer_gt(integer_from_small(45), integer_from_small(45)), false);
  expect(integer_gt(integer_parse("5498765432109876"), integer_parse("4598765432109876")), true);
  expect(integer_gt(integer_parse("4598765432109876"), integer_parse("5498765432109876")),false);
  expect(integer_gt(integer_parse("4598765432109876"), integer_parse("4598765432109876")),false);
};

void test_addx() {
  printf("addition\n");
  expect_eq(integer_add(integer_from_small(0),integer_parse("9844190321790980841789")),integer_parse("9844190321790980841789"));
  expect_eq(integer_add(integer_parse("9844190321790980841789"), integer_from_small(0)), integer_parse("9844190321790980841789"));
  expect_eq(integer_add(integer_from_small(0), integer_parse("-9844190321790980841789")), integer_parse("-9844190321790980841789"));
  expect_eq(integer_add(integer_parse("-9844190321790980841789"), integer_from_small(0)), integer_parse("-9844190321790980841789"));
  expect_eq(integer_add(integer_parse("-9007199254740983"), integer_parse("-9999999999999998")), integer_parse("-19007199254740981"));

  expect_eq(integer_add(integer_parse("1234567890987654321"),integer_parse("9876543210123456789")),integer_parse("11111111101111111110"));
  expect_eq(integer_add(integer_parse("1234567890987654321"),integer_parse("-9876543210123456789")),integer_parse("-8641975319135802468"));
  expect_eq(integer_add(integer_parse("-1234567890987654321"),integer_parse("9876543210123456789")),integer_parse("8641975319135802468"));
  expect_eq(integer_add(integer_parse("-1234567890987654321"),integer_parse("-9876543210123456789")),integer_parse("-11111111101111111110"));
  expect_eq(integer_add(integer_parse("9876543210123456789"),integer_parse("1234567890987654321")),integer_parse("11111111101111111110"));
  expect_eq(integer_add(integer_parse("9876543210123456789"),integer_parse("-1234567890987654321")),integer_parse("8641975319135802468"));
  expect_eq(integer_add(integer_parse("-9876543210123456789"),integer_parse("1234567890987654321")),integer_parse("-8641975319135802468"));
  expect_eq(integer_add(integer_parse("-9876543210123456789"),integer_parse("-1234567890987654321")),integer_parse("-11111111101111111110"));

  expect_eq(integer_sub(integer_parse("1234567890987654321"),integer_parse("9876543210123456789")),integer_parse("-8641975319135802468"));
  expect_eq(integer_sub(integer_parse("1234567890987654321"),integer_parse("-9876543210123456789")),integer_parse("11111111101111111110"));
  expect_eq(integer_sub(integer_parse("-1234567890987654321"),integer_parse("9876543210123456789")),integer_parse("-11111111101111111110"));
  expect_eq(integer_sub(integer_parse("-1234567890987654321"),integer_parse("-9876543210123456789")),integer_parse("8641975319135802468"));
  expect_eq(integer_sub(integer_parse("9876543210123456789"),integer_parse("1234567890987654321")),integer_parse("8641975319135802468"));
  expect_eq(integer_sub(integer_parse("9876543210123456789"),integer_parse("-1234567890987654321")),integer_parse("11111111101111111110"));
  expect_eq(integer_sub(integer_parse("-9876543210123456789"),integer_parse("1234567890987654321")),integer_parse("-11111111101111111110"));
  expect_eq(integer_sub(integer_parse("-9876543210123456789"),integer_parse("-1234567890987654321")),integer_parse("-8641975319135802468"));
}

#define append10(s) s s s s s s s s s s

const char* a = "1234567890";
const char* b = append10("1234567890");
const char* c = append10(append10("1234567890"));
const char* d = append10(append10(append10("1234567890")));
// const char* e = append10(append10(append10(append10("1234567890"))));


void test_carry() {
  const char* fibs[] = { "1", "1", "2", "3", "5", "8", "13", "21", "34", "55", "89", "144", "233", "377", "610", "987", "1597", "2584", "4181", "6765", "10946", "17711", "28657", "46368", "75025", "121393", "196418", "317811", "514229", "832040", "1346269", "2178309", "3524578", "5702887", "9227465", "14930352", "24157817", "39088169", "63245986", "102334155", "165580141", "267914296", "433494437", "701408733", "1134903170", "1836311903", "2971215073", "4807526976", "7778742049", "12586269025" };
  integer num = integer_from_small(1);
  integer last = integer_from_small(1);

  for (intptr_t i = 2; i < 50; i++) {
    integer_incref(last);
    num = integer_add(num,last);
    integer_incref(num);
    last = integer_sub(num,last);
    integer_incref(num);
    expect_eq(num,integer_parse(fibs[i]));
  }
  integer_decref(num);
  integer_decref(last);

  expect_eq(integer_add(integer_parse("9007199254740991"),integer_from_small(1)), integer_parse("9007199254740992"));
  expect_eq(integer_add(integer_parse("999999999999999999999000000000000000000000"),integer_parse("1000000000000000000000")),integer_parse("1e42"));
  expect_eq(integer_add(integer_parse("1e20"), integer_parse("9007199254740972")), integer_parse("100009007199254740972"));
  expect_eq(integer_add(integer_parse("-9007199254740983"), integer_parse("-9999999999999998")), integer_parse("-19007199254740981"));

  expect_eq(integer_sub(integer_parse(c), integer_add(integer_parse(b), integer_from_small(1))), integer_parse("1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678899999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999"));
  expect_eq(integer_sub(integer_parse(b), integer_add(integer_parse(c), integer_from_small(1))), integer_parse("-1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001"));
  expect_eq(integer_sub(integer_parse("100000000000000000000000000000000000"),integer_parse("999999999999999999")), integer_parse("99999999999999999000000000000000001"));
  expect_eq(integer_sub(integer_parse("10000000010000000"), integer_parse("10000000")), integer_parse("10000000000000000"));
}

static integer factorial(integer n) {
  integer_incref(n); 
  if (integer_eq(n,integer_from_small(0))) {
    integer_decref(n);
    return integer_from_small(1);
  }
  integer_incref(n);
  if (integer_eq(n, integer_from_small(1))) {
    integer_decref(n);
    return integer_from_small(1);
  }
  integer_incref(n);
  return integer_mul(factorial(integer_dec(n)),n);
}

void test_large() {
  const char* tenFactorial = "3628800";
  const char* hundredFactorial = "93326215443944152681699238856266700490715968264381621468592963895217599993229915608941463976156518286253697920827223758251185210916864000000000000000000000000";
  const char* threeToTenThousand = "16313501853426258743032567291811547168121324535825379939348203261918257308143190787480155630847848309673252045223235795433405582999177203852381479145368112501453192355166224391025423628843556686559659645012014177448275529990373274425446425751235537341867387607813619937225616872862016504805593174059909520461668500663118926911571773452255850626968526251879139867085080472539640933730243410152186914328917354576854457274195562218013337745628502470673059426999114202540773175988199842487276183685299388927825296786440252999444785694183675323521704432195785806270123388382931770198990841300861506996108944782065015163410344894945809337689156807686673462563038164792190665340124344133980763205594364754963451564072340502606377790585114123814919001637177034457385019939060232925194471114235892978565322415628344142184842892083466227875760501276009801530703037525839157893875741192497705300469691062454369926795975456340236777734354667139072601574969834312769653557184396147587071260443947944862235744459711204473062937764153770030210332183635531818173456618022745975055313212598514429587545547296534609597194836036546870491771927625214352957503454948403635822345728774885175809500158451837389413798095329711993092101417428406774326126450005467888736546254948658602484494535938888656542746977424368385335496083164921318601934977025095780370104307980276356857350349205866078371806065542393536101673402017980951598946980664330391505845803674248348878071010412918667335823849899623486215050304052577789848512410263834811719236949311423411823585316405085306164936671137456985394285677324771775046050970865520893596151687017153855755197348199659070192954771308347627111052471134476325986362838585959552209645382089055182871854866744633737533217524880118401787595094060855717010144087136495532418544241489437080074716158404895914136451802032446707961058757633345691696743293869623745410870051851590672859347061212573446572045088465460616826082579731686004585218284333452396157730036306379421822435818001505905203918209206969662326706952623512427380240468784114535101496733983401240219840048956733689309620321613793757156727562461651933397540266795963865921590913322060572673349849253303397874242381960775337182730037783698708748781738419747698880321601186310506332869704931303076839444790968339306301273371014087248060946851793697973114432706759288546077622831002526800554849696867710280945946603669593797354642136622231192695027321229511912952940320879763123151760555959496961163141455688278842949587288399100273691880018774147568892650186152065335219113072582417699616901995530249937735219099786758954892534365835235843156112799728164123461219817343904782402517111603206575330527850752564642995318064985900815557979945885931124351303252811255254295797082281946658798705979077492469849644183166585950844953164726896146168297808178398470451561320526180542310840744843107469368959707726836608471817060598771730170755446473440774031371227437651048421606224757527085958515947273151027400662948161111284777828103531499488913672800783167888051177155427285103861736658069404797695900758820465238673970882660162285107599221418743657006872537842677883708807515850397691812433880561772652364847297019508025848964833883225165668986935081274596293983121864046277268590401580209059988500511262470167150495261908136688693861324081559046336288963037090312033522400722360882494928182809075406914319957044927504420797278117837677431446979085756432990753582588102440240611039084516401089948868433353748444104639734074519165067632941419347985624435567342072815910754484123812917487312938280670403228188813003978384081332242484646571417574404852962675165616101527367425654869508712001788393846171780457455963045764943565964887518396481296159902471996735508854292964536796779404377230965723361625182030798297734785854606060323419091646711138678490928840107449923456834763763114226000770316931243666699425694828181155048843161380832067845480569758457751090640996007242018255400627276908188082601795520167054701327802366989747082835481105543878446889896230696091881643547476154998574015907396059478684978574180486798918438643164618541351689258379042326487669479733384712996754251703808037828636599654447727795924596382283226723503386540591321268603222892807562509801015765174359627788357881606366119032951829868274617539946921221330284257027058653162292482686679275266764009881985590648534544939224296689791195355783205968492422636277656735338488299104238060289209390654467316291591219712866052661347026855261289381236881063068219249064767086495184176816629077103667131505064964190910450196502178972477361881300608688593782509793781457170396897496908861893034634895715117114601514654381347139092345833472226493656930996045016355808162984965203661519182202145414866559662218796964329217241498105206552200001";
  
  expect_eq(factorial(integer_from_small(10)),integer_parse(tenFactorial));
  expect_eq(factorial(integer_from_small(100)),integer_parse(hundredFactorial));
  expect_eq(integer_pow(integer_from_small(3),integer_from_int(10000)), integer_parse(threeToTenThousand));

  // large multiply divide
  integer x = integer_from_str(hundredFactorial);
  expect_eq(integer_div(integer_mul(integer_dup(x), integer_dup(x)),integer_dup(x)), x);
  x = integer_from_str(threeToTenThousand);
  expect_eq(integer_div(integer_mul(integer_dup(x), integer_dup(x)), integer_dup(x)), x);
  integer y = integer_from_str(hundredFactorial);
  x = integer_from_str(threeToTenThousand);
  expect_eq(integer_div(integer_mul(integer_dup(y), integer_dup(x)), y), x);
}

void test_div() {
  expect_eq(integer_div(integer_parse("163500573666152634716420931676158"), integer_from_int(13579)), integer_parse("12040693251797086288859336598"));
  expect_eq(integer_div(integer_parse("163500573666152634716420931676158"), integer_from_int(-13579)), integer_parse("-12040693251797086288859336598"));
  expect_eq(integer_div(integer_parse("-163500573666152634716420931676158"), integer_from_int(13579)), integer_parse("-12040693251797086288859336598"));
  expect_eq(integer_div(integer_parse("-163500573666152634716420931676158"), integer_from_int(-13579)), integer_parse("12040693251797086288859336598"));

  expect_eq(integer_div(integer_parse("1234567890987654321"), integer_parse("132435465768798")), integer_parse("9322"));
  expect_eq(integer_div(integer_parse("1234567890987654321"), integer_parse("-132435465768798")), integer_parse("-9322"));
  expect_eq(integer_div(integer_parse("-1234567890987654321"), integer_parse("132435465768798")), integer_parse("-9322"));
  expect_eq(integer_div(integer_parse("-1234567890987654321"), integer_parse("-132435465768798")), integer_parse("9322"));

  expect_eq(integer_div(integer_parse("786456456335437356436"), integer_parse("-5423424653")), integer_parse("-145011041298"));
  expect_eq(integer_div(integer_parse("-93453764643534523"), integer_parse("-2342")), integer_parse("39903400787162"));
  expect_eq(integer_div(integer_parse("10000000000000000"), integer_parse("-10000000000000000")), integer_parse("-1"));

  expect_eq(integer_div(integer_parse("98789789419609840614360398703968368740365403650364036403645046"), integer_from_small(-1)), integer_parse("-98789789419609840614360398703968368740365403650364036403645046"));
  
  expect_eq(integer_div(integer_parse("98109840984098409156481068456541684065964819841065106865710397464513210416435401645030648036034063974065004951094209420942097421970490274195049120974210974209742190274092740492097420929892490974202241981098409840984091564810684565416840659648198410651068657103974645132104164354016450306480360340639740650049510942094209420974219704902741950491209742109742097421902740927404920974209298924909742022419810984098409840915648106845654168406596481984106510686571039746451321041643540164503064803603406397406500495109420942094209742197049027419504912097421097420974219027409274049209742092989249097420224198109840984098409156481068456541684065964819841065106865710397464513210416435401645030648036034063974065004951094209420942097421970490274195049120974210974209742190274092740492097420929892490974202241981098409840984091564810684565416840659648198410651068657103974645132104164354016450306480360340639740650049510942094209420974219704902741950491209742109742097421902740927404920974209298924909742022419810984098409840915648106845654168406596481984106510686571039746451321041643540164503064803603406397406500495109420942094209742197049027419504912097421097420974219027409274049209742092989249097420224198109840984098409156481068456541684065964819841065106865710397464513210416435401645030648036034063974065004951094209420942097421970490274195049120974210974209742190274092740492097420929892490974202241981098409840984091564810684565416840659648198410651068657103974645132104164354016450306480360340639740650049510942094209420974219704902741950491209742109742097421902740927404920974209298924909742022419810984098409840915648106845654168406596481984106510686571039746451321041643540164503064803603406397406500495109420942094209742197049027419504912097421097420974219027409274049209742092989249097420224198109840984098409156481068456541684065964819841065106865710397464513210416435401645030648036034063974065004951094209420942097421970490274195049120974210974209742190274092740492097420929892490974202241"),integer_parse("98109840984098409156481068456541684065964819841065106865710397464513210416435401645030648036034063974065004951094209420942097421970490274195049120974210974209742190274092740492097420929892490974202241")), integer_parse("1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001"));
  //expect_eq(integer_div(integer_parse(e),integer_parse(d)),integer_parse("100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001"));
  expect_eq(integer_div(integer_parse("1e1050"), integer_parse("1e1000")), integer_parse("1e50"));
  expect_eq(integer_div(integer_parse("650891045068740450350436540352434350243346254305240433565403624570436542564034355230360437856406345450735366803660233645540323657640436735034636550432635454032364560324366403643455063652403346540263364032643454530236455402336455640363263405423565405623454062354540326564062306456432664546654436564364556406435460643646363545606345066534456065340165344065234064564"), integer_parse("2634565230452364554234565062345452365450236455423654456253445652344565423655423655462534506253450462354056523445062535462534052654350426355023654540625344056203455402635454026435501635446643754664546780646476442344654465764466744566754436556406235454066354570657548036545465")), integer_parse("247058238507527885509216194910087226997858456323482112332514020694766925604284002588230023"));
  expect_eq(integer_div(integer_parse("650891045068740450350436540352434350243346254305240433565403624570436542564034355230360437856406345450735366803660233645540323657640436735034636550432635454032364560324366403643455063652403346540263364032643454530236455402336455640363263405423565405623454062354540326564062306456432664546654436564364556406435460643646363545606345066534456065340165344065234064564000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"), integer_parse("2634565230452364554234565062345452365450236455423654456253445652344565423655423655462534506253450462354056523445062535462534052654350426355023654540625344056203455402635454026435501635446643754664546780646476442344654465764466744566754436556406235454066354570657548036545465000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000")), integer_parse("247058238507527885509216194910087226997858456323482112332514020694766925604284002588230023"));
  expect_eq(integer_div(integer_parse("9999999999999900000000000000"), integer_parse("999999999999990000001")), integer_parse("9999999")); 
  expect_eq(integer_div(integer_parse("1e9999"), integer_parse("1e999")), integer_parse("1e9000"));
}


void test_count() {
  expect_eq(integer_count_digits(integer_from_int(0)), integer_from_int(1));
  expect_eq(integer_count_digits(integer_from_int(9999)), integer_from_int(4));
  expect_eq(integer_count_digits(integer_from_int(70123)), integer_from_int(5));
  expect_eq(integer_count_digits(integer_from_int(-70123)), integer_from_int(5));
  expect_eq(integer_count_digits(integer_parse("1234567890")), integer_from_int(10));
  expect_eq(integer_count_digits(integer_neg(integer_from_str(b))), integer_from_int(100));

  expect_eq(integer_ctz(integer_from_int(0)), integer_from_int(0));
  expect_eq(integer_ctz(integer_from_int(-9900)), integer_from_int(2));
  expect_eq(integer_ctz(integer_from_int(70000)), integer_from_int(4));
  expect_eq(integer_ctz(integer_parse("100000000")), integer_from_int(8));
  expect_eq(integer_ctz(integer_parse("10000000000")), integer_from_int(10));
  expect_eq(integer_ctz(integer_parse("1000000000000000000")), integer_from_int(18));
}

void test_pow10() {
  expect_eq(integer_mul_pow10(integer_parse("1234567890"),integer_from_int(0)), integer_parse("1234567890"));
  expect_eq(integer_mul_pow10(integer_from_int(0), integer_parse("1234567890")), integer_from_int(0));
  expect_eq(integer_mul_pow10(integer_from_int(-1), integer_parse("12")), integer_parse("-1e12"));
  expect_eq(integer_mul_pow10(integer_parse("1234567890"), integer_from_int(8)), integer_parse("1234567890e8"));
  expect_eq(integer_mul_pow10(integer_parse("-1234567890"), integer_from_int(8)), integer_parse("-1234567890e8"));
  expect_eq(integer_mul_pow10(integer_parse("1234567890"), integer_from_int(18)), integer_parse("1234567890e18"));
  expect_eq(integer_mul_pow10(integer_from_int(1234), integer_from_int(14)), integer_parse("1234e14"));

  expect_eq(integer_div_pow10(integer_parse("1234567890"), integer_from_int(0)), integer_parse("1234567890"));
  expect_eq(integer_div_pow10(integer_from_int(0), integer_parse("1234567890")), integer_from_int(0));
  expect_eq(integer_div_pow10(integer_parse("-1e13"), integer_parse("12")), integer_parse("-10"));
  expect_eq(integer_div_pow10(integer_parse("1234567890"), integer_from_int(8)), integer_parse("12"));
  expect_eq(integer_div_pow10(integer_parse("-1234567890"), integer_from_int(8)), integer_parse("-12"));
  expect_eq(integer_div_pow10(integer_parse("9999999999"), integer_from_int(8)), integer_parse("99"));
  expect_eq(integer_div_pow10(integer_parse("1234567890"), integer_from_int(18)), integer_from_int(0));
  expect_eq(integer_div_pow10(integer_parse("1234e14"), integer_from_int(14)), integer_parse("1234"));
}

static integer ia;
static integer ib;
static integer ic;

static void init_nums(void) {
  ia = integer_from_str(a);
  ib = integer_from_str(b);
  ic = integer_from_str(c);
}

static integer init_num(size_t  digits) {
  char* s = malloc(digits + 1);
  for (size_t i = 0; i < digits; i++) {
    s[i] = '0' + (9 - (i%10));
  }
  s[digits] = 0;
  integer x = integer_from_str(s);
  free(s);
  return x;
}

static void test_mul(integer x, integer y) {
  integer i = integer_mul(x,y); 
  integer_decref(i);
}
static void test_mulk(integer x, integer y) {
  integer i = integer_mul_karatsuba(x, y);
  integer_decref(i);
}


int main() {
  test_fib(50);   // 12586269025
  test_fib(150);  // 9969216677189303386214405760200
  test_fib(300);  // 22223224462942044552973989346190996720666693909649976499097960
  test_read("123456789");
  test_read("12586269025");
  test_read("99692166771893033862144057602");
  test_read("22223224462942044552973989346190996720666693909649976499097960");
  test_cmp_pos();
  test_addx();
  test_carry();
  test_large();
  test_div();
  test_count();
  test_pow10();

  /*
  init_nums();
  for (int i = 100; i < 800; i+=50) {
    integer x = init_num(i);
    for (int j = 100; j < 800; j += 50) {
      integer y = init_num(j);
      printf(".");
      msecs_t t1 = test_timing("multiply l", 10000, test_mul, integer_dup(x), integer_dup(y));
      msecs_t t2 = test_timing("multiply k", 10000, test_mulk, integer_dup(x), integer_dup(y));
      //printf("test digit count: %i x %i: predict: %s\n", i, j, (use_karatsuba(i, j) ? "karatsuba" : "long"));
      if (use_karatsuba(i,j) != (t1 >(t2 + (t2/50)))) {
        printf("\n***: %i x %i, predict: %s, but winner was: %s (%3.3f s vs %3.3f s)\n", i, j, (use_karatsuba(i, j) ? "karatsuba" : "long"), (t1 >(t2 + (t2/50))) ? "karatsuba" : "long", t1/1000.0, t2/1000.0 );
      }
      integer_decref(y);
    }
    integer_decref(x);
  }
  */
  return 0;
}

/*

inline ptr acquire(ptr p) {
  block_of(p)->header.refcount_full++;
  return p;
}

inline ptr shallow_release(ptr p) {
  block_t* b = block_of(p);
  b->header.refcount_full--;
  if (b->header.refcount_lo == 0 && b->header.refcount_hi == 0) {
    kk_free(b);
  }
  return p;
}

inline ptr release(ptr p) {
  shallow_release(p);
}

inline boxed boxed_acquire(boxed b) {
  if (is_ptr(b)) {
    acquire(unbox_ptr(b));
  }
  return b;
}

inline boxed boxed_release(boxed b) {
  if (is_ptr(b)) {
    release(unbox_ptr(b));
  }
  return b;
}

inline bool _check_reuse(ptr p, tag_t tag) {
  if (p == 0) return false;
  assert(tag_of(p) == tag);
  block_t* b = block_of(p);
  if (b->header.refcount_lo==1 && b->header.refcount_hi==0) {
    return true;
  }
  else {
    assert(b->header.refcount > 1);
    b->header.refcount_full--;
    return false;
  }
}

#define alloc_tp_reuse(tp,reuse,n,tag)   (_check_reuse(reuse,tag) ? tp_of(tp,reuse) : alloc_tp(tp,n,tag));

#define list_tag_nil  1
#define list_tag_cons 2

struct list_nil_t { header_t header;  };

ptr list_nil() {
  static struct list_nil_t _nil = { HEADER(list_tag_nil) };
  return acquire(make_ptr(&_nil,list_tag_nil));
}

struct list_cons_t { boxed head; ptr tail; };

ptr list_cons(ptr reuse, boxed head, ptr tail) {
  struct list_cons_t* c = alloc_tp_reuse(struct list_cons_t, reuse, 2, list_tag_cons);
  c->head = head;
  c->tail = tail;
  return make_ptr(c, list_tag_cons);
}

typedef ptr function;

boxed apply(function f, boxed arg) {
  return arg;
}

bool unwind = false;

ptr map(function f, ptr xs) {
  if (tag_of(xs) == list_tag_cons) {
    struct list_cons_t* cons = tp_of(struct list_cons_t, xs);
    boxed x = cons->head;
    ptr xx  = cons->tail;    
    boxed y = apply(acquire(f), x);   if (unwind) { release(f); release(xx); shallow_release(xs);  return 0; }
    ptr ys  = map(f, xx);             if (unwind) { release(y); shallow_release(xs); return 0; };
    return list_cons(xs, y, ys);  
  }
  else {
    release(xs);
    return nil();
  }
  return 0;
}

integer test_add(integer x) {
  integer res = int_add(x, int_small(4));
  return res;
}

int main(int argc, char** argv ) {
  integer i = test_add(int_small(argc));
  if (i) printf("uh oh\n");
	    else printf("hello world!\n");
}
*/